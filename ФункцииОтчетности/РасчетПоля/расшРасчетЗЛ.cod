extends Ѕюджет_«ѕиƒƒ.–асчетѕол€.–—¬1.–асчет«Ћ;

inclass public

  proc –асчет—ведений—тажа (_”чреждение, _‘изЋицо: Ѕазовый.ƒанные.—убъект;
                            _«аписьѕериода в: “ЅЅ_Ѕазовый.—правочники.ѕериоды–асчета;
                            _м одћс: string[];
                            _ онтейнерѕолей: “ЅЅ_ќтчетность.ќбъектыќтчета.ѕол€»ндексные; _»ндексѕол€: integer);
    var locFlt: string[];
    var лок“ест: numeric;
    var локѕериоды—трахового—тажа: variant[2];
    var p, pp, ns: integer;
    var локƒтЌс, локƒт с: date;
    locFlt[1] = 'Ќаше”чреждение=' + Str(_”чреждение);
    locFlt[2] = '‘излицо=' + Str(_‘изЋицо);
    locFlt[3] = ' од‘онда="' + Ѕюджет_«ѕиƒƒ. онстанты.ѕ‘– + '"';
    locFlt[4] = '¬–асчете<>0';
    locFlt[5] = '–асчетныйѕериод. од in ' + ToStr(_м одћс);
    locFlt[6] = '–асчет.√руппаЌачислений = "1000"';
    with Query.Create([Ѕюджет_«ѕиƒƒ.–асчетныеќперации.¬знос]) do
      Filter = —»—2.—троковые‘ункции.—ложить—троки‘ильтраѕо»(locFlt);
      лок“ест = CalcAggregates('Sum(—умма ”чету)') as numeric;
    end;
    if (лок“ест > 0):
      локѕериоды—трахового—тажа = Ѕюджет_ѕерсонал.—траховой—тажќпс.ѕериоды—трахового—тажа‘акт(_”чреждение, _‘изЋицо, _«аписьѕериода в) as variant[2]; --Trace(локѕериоды—трахового—тажа);
      pp = LengthOfArray(локѕериоды—трахового—тажа);
      —охранить«начениеѕол€«Ћ(_ онтейнерѕолей, 'ц:ѕозиций—вд—тажа', _»ндексѕол€, pp);
      for p = 1 .. pp do
        ns = ((p - 1)) + 801;
        локƒтЌс = локѕериоды—трахового—тажа[p,1] as date;
        локƒт с = локѕериоды—трахового—тажа[p,2] as date;
        —охранить«начениеѕол€«Ћ(_ онтейнерѕолей, 'д:Ќач.' + Str(ns), _»ндексѕол€, локƒтЌс);
        —охранить«начениеѕол€«Ћ(_ онтейнерѕолей, 'д: он.' + Str(ns), _»ндексѕол€, локƒт с);
        if (локѕериоды—трахового—тажа[p,3] <> nil):
          if (локѕериоды—трахового—тажа[p,3] in ['¬–Ќ≈“–”ƒ','ƒ≈ –≈“']):
            —охранить«начениеѕол€«Ћ(_ онтейнерѕолей, 'с: од»“—дп3.' + Str(ns), _»ндексѕол€, локѕериоды—трахового—тажа[p,3] as string);
            —охранить«начениеѕол€«Ћ(_ онтейнерѕолей, 'с: од»“—дс.' + Str(ns), _»ндексѕол€, '[0][0][' + локѕериоды—трахового—тажа[p,3] as string + ']');
          fi;
        fi;
      od;
    else
      locFlt = nil;
      locFlt[1] = 'Ќаше”чреждение=' + Str(_”чреждение);
      locFlt[2] = '—убъект=' + Str(_‘изЋицо);
      locFlt[3] = “ЅЅ_Ѕазовый.‘ильтры.‘ильтрѕоƒатам(_«аписьѕериода в.ƒатаЌачала,_«аписьѕериода в.ƒатаќкончани€);
      with Query.Create([”чет—тажа.–асчетный—таж]) do
        Filter = —»—2.—троковые‘ункции.—ложить—троки‘ильтраѕо»(locFlt);
        if RecordsExists:
          Select;
          локƒтЌс = Current.ƒатаЌачала;
          локƒтЌс = Max([локƒтЌс, _«аписьѕериода в.ƒатаЌачала]);
          локƒт с = Current.ƒатаќкончани€;
          локƒт с = Min([локƒт с, _«аписьѕериода в.ƒатаќкончани€]);
          —охранить«начениеѕол€«Ћ(_ онтейнерѕолей, 'д:Ќач.801', _»ндексѕол€, локƒтЌс);
          —охранить«начениеѕол€«Ћ(_ онтейнерѕолей, 'д: он.801', _»ндексѕол€, локƒт с);
        fi;
      end;
    fi;
  end;

end